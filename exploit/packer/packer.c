// Packer.c - Scripting system for socket connections
#include "../../lib/socketlib.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

// Global socket file descriptor
int socketFD = -1;

// Helper function to convert escape sequences (e.g., \r\n)
char *unescape(const char *str) {
    static char buf[1024];
    int i = 0, j = 0;

    // Loop over each part of the buffer, and encode escape sequences
    // This code is very complicated and fragile, but it does work
    while (str[i] && j < sizeof(buf) - 1) {
        if (str[i] == '\\' && str[i + 1]) {
            if (str[i + 1] == 'n') { buf[j++] = '\n'; i += 2; }
            else if (str[i + 1] == 'r') { buf[j++] = '\r'; i += 2; }
            else if (str[i + 1] == 't') { buf[j++] = '\t'; i += 2; }
            else { buf[j++] = str[i++]; }
        } else {
            buf[j++] = str[i++];
        }
    }
    buf[j] = '\0';
    return buf;
}

// Execute a single line of script
void executeLine(char *lineBuffer) {
    // Remove the newline character
    char *command = strtok(lineBuffer, " \n");
    if (!command) return;

    // Connect command
    // Usage: connect <IP> <Port>
    // Note this does not work with hostnames or domain names
    // Use DNSTool utility to find the IP of a domain
    if (strcmp(command, "connect") == 0) {
        // Get the required tokens for making a connection
        char *ip = strtok(NULL, " \n");
        char *portStr = strtok(NULL, " \n");

        if (ip && portStr) {
            int port = atoi(portStr);
            socketFD = TCPClientConnect(ip, port, 2);
            if (socketFD >= 0)
                printf("[+] Connected to %s:%d\n", ip, port);
            else
                printf("[-] Failed to connect to %s:%d\n", ip, port);
        } else {
            printf("[-] Usage: connect <IP> <Port>\n");
        }

    // Send data to the socket currently connected
    // This can be HTTP requests, and works with any protocal if the data is correct
    // Usage: send <Data>
    } else if (strcmp(command, "send") == 0) {
        char *rawMsg = strtok(NULL, "\n");
        if (rawMsg && socketFD >= 0) {
            char *msg = unescape(rawMsg);
            ssize_t sent = TCPSend(socketFD, msg, strlen(msg));
            printf("[+] Sent %zd bytes\n", sent);
        } else {
            printf("[-] Usage: send <message>\n");
        }

    // Receive data from the connected socket
    } else if (strcmp(command, "recv") == 0) {
        if (socketFD >= 0) {
            // Receive data into a buffer from the socket
            char buffer[8192];
            ssize_t received = TCPRecv(socketFD, buffer, sizeof(buffer) - 1);
            if (received > 0) {
                // Print the data
                buffer[received] = '\0';
                printf("[+] Received:\n%s\n", buffer);
            } else {
                printf("[-] No data received or error.\n");
            }
        }

    // Disconnect a socket
    } else if (strcmp(command, "close") == 0) {
        if (socketFD >= 0) {
            TCPClose(socketFD);
            printf("[+] Connection closed\n");
            socketFD = -1;
        }

    // Unknown command
    } else {
        printf("[-] Unknown command: %s\n", command);
    }
}

// Open and run the script file
void runScript(const char *scriptName) {
    FILE *scriptFile = fopen(scriptName, "r");
    if (!scriptFile) {
        perror("fopen");
        exit(1);
    }

    // Loop over each line
    char lineBuffer[256];
    while (fgets(lineBuffer, sizeof(lineBuffer), scriptFile)) {
        // Give the line to the execute line function
        executeLine(lineBuffer);
    }

    fclose(scriptFile);
}

// Main entry point
int main(int argc, char *argv[]) {
    if (argc < 2) {
        printf("Usage: ./packer <script_file>\n");
        exit(1);
    }

    runScript(argv[1]);
    return 0;
}
